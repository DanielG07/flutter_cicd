name: Dynamic Environment File Creation

on:
  push:
    branches: [ create-env-file ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      ENVIRONMENT:
        description: 'Environment (PROD or QA)'
        required: true
        type: choice
        options:
          - QA
          - PROD
        default: 'QA'
      TARGET_APP:
        description: 'Target App'
        required: true
        type: choice
        options:
          - APP1
          - APP2
        default: 'APP1'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create file .env
        run: |
          # Establecer valores por defecto si es push automático
          ENV="${{ inputs.ENVIRONMENT || 'QA' }}"
          APP="${{ inputs.TARGET_APP || 'APP1' }}"

          echo "$ENV_FILE" >> .env

          echo "Created example.env file with:"
          cat .env
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}

      - name: Verify .env file before upload
        run: |
          echo "=== Verification before upload ==="
          if [ -f ".env" ]; then
            echo "✅ File exists: .env"
            echo "Size: $(stat -f%z .env 2>/dev/null || stat -c%s .env) bytes"
            echo "Lines: $(wc -l < .env)"
            echo "Path: $(realpath .env)"
          else
            echo "❌ ERROR: .env file not found!"
            ls -la
            exit 1
          fi

      - name: Upload env file
        uses: actions/upload-artifact@v4
        with:
          name: env-file
          path: example.env
          retention-days: 1