name: Dynamic Secrets with Format

on:
  push:
    branches: [ dynamic-secrets ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      ENVIRONMENT:
        description: 'Environment (PROD or QA)'
        required: true
        type: choice
        options:
          - QA
          - PROD
        default: 'QA'
      TARGET_APP:
        description: 'Target App'
        required: true
        type: choice
        options:
          - APP1
          - APP2
        default: 'APP1'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          # Establecer valores por defecto si es push automático
          ENV="${{ inputs.ENVIRONMENT || 'QA' }}"
          APP="${{ inputs.TARGET_APP || 'APP1' }}"

          echo "ENVIRONMENT=$ENV" >> $GITHUB_ENV
          echo "TARGET_APP=$APP" >> $GITHUB_ENV

          echo "Deploying to Environment: $ENV"
          echo "Target App: $APP"

      - name: Use dynamic secrets with format
        env:
          # Acceso dinámico a secretos usando format()
          TOKEN: ${{ secrets[format('TOKEN_{0}', inputs.ENVIRONMENT || 'QA')] }}

          # Con múltiples variables
          FIREBASE_APP_ID_ANDROID: ${{ secrets[format('FIREBASE_APP_ID_ANDROID_{0}_{1}', inputs.TARGET_APP || 'APP1', inputs.ENVIRONMENT || 'QA')] }}

          # Más ejemplos de secretos dinámicos
          API_KEY: ${{ secrets[format('API_KEY_{0}', inputs.ENVIRONMENT || 'QA')] }}
          DATABASE_URL: ${{ secrets[format('DATABASE_URL_{0}', inputs.ENVIRONMENT || 'QA')] }}
          SUPABASE_URL: ${{ secrets[format('SUPABASE_URL_{0}', inputs.ENVIRONMENT || 'QA')] }}
          SUPABASE_ANON_KEY: ${{ secrets[format('SUPABASE_ANON_KEY_{0}', inputs.ENVIRONMENT || 'QA')] }}

        run: |
          echo "Environment: ${{ inputs.ENVIRONMENT || 'QA' }}"
          echo "Target App: ${{ inputs.TARGET_APP || 'APP1' }}"
          echo ""
          echo "Secrets loaded:"
          echo "- TOKEN configured: $([ -n "$TOKEN" ] && echo 'Yes' || echo 'No')"
          echo "- FIREBASE_APP_ID_ANDROID configured: $([ -n "$FIREBASE_APP_ID_ANDROID" ] && echo 'Yes' || echo 'No')"
          echo "- API_KEY configured: $([ -n "$API_KEY" ] && echo 'Yes' || echo 'No')"
          echo "- DATABASE_URL configured: $([ -n "$DATABASE_URL" ] && echo 'Yes' || echo 'No')"

          # Usar los secretos en tu deployment
          if [ -n "$TOKEN" ]; then
            echo "Token length: ${#TOKEN} characters"
          fi

      - name: Deploy to environment
        env:
          TOKEN: ${{ secrets[format('TOKEN_{0}', inputs.ENVIRONMENT || 'QA')] }}
          FIREBASE_APP_ID: ${{ secrets[format('FIREBASE_APP_ID_ANDROID_{0}_{1}', inputs.TARGET_APP || 'APP1', inputs.ENVIRONMENT || 'QA')] }}
        run: |
          echo "Starting deployment..."

          # Aquí usarías los secretos para tu deployment real
          # Ejemplo:
          # curl -H "Authorization: Bearer $TOKEN" \
          #      -H "X-Firebase-AppId: $FIREBASE_APP_ID" \
          #      https://api.example.com/deploy

          echo "Deployment completed successfully!"

      - name: Example with multiple secret patterns
        env:
          # Patrón 1: ENVIRONMENT solo
          SECRET_1: ${{ secrets[format('TOKEN_{0}', inputs.ENVIRONMENT || 'QA')] }}

          # Patrón 2: APP y ENVIRONMENT
          SECRET_2: ${{ secrets[format('FIREBASE_APP_ID_ANDROID_{0}_{1}', inputs.TARGET_APP || 'APP1', inputs.ENVIRONMENT || 'QA')] }}

          # Patrón 3: Con plataforma
          SECRET_3: ${{ secrets[format('FIREBASE_APP_ID_IOS_{0}_{1}', inputs.TARGET_APP || 'APP1', inputs.ENVIRONMENT || 'QA')] }}

        run: |
          echo "All secrets configured for dynamic access"
          echo "Pattern examples:"
          echo "- TOKEN_QA or TOKEN_PROD"
          echo "- FIREBASE_APP_ID_ANDROID_APP1_QA"
          echo "- FIREBASE_APP_ID_ANDROID_APP2_PROD"
          echo "- FIREBASE_APP_ID_IOS_APP1_QA"

