name: Dynamic Secrets with Format

on:
  push:
    branches: [ dynamic-secrets ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      ENVIRONMENT:
        description: 'Environment (PROD or QA)'
        required: true
        type: choice
        options:
          - QA
          - PROD
        default: 'QA'
      TARGET_APP:
        description: 'Target App'
        required: true
        type: choice
        options:
          - APP1
          - APP2
        default: 'APP1'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          # Establecer valores por defecto si es push automático
          ENV="${{ inputs.ENVIRONMENT || 'QA' }}"
          APP="${{ inputs.TARGET_APP || 'APP1' }}"

          echo "ENVIRONMENT=$ENV" >> $GITHUB_ENV
          echo "TARGET_APP=$APP" >> $GITHUB_ENV

          echo "Deploying to Environment: $ENV"
          echo "Target App: $APP"

      - name: Validate secret names being accessed
        run: |
          # Mostrar qué secretos se están intentando acceder
          ENV="${{ inputs.ENVIRONMENT || 'QA' }}"
          APP="${{ inputs.TARGET_APP || 'APP1' }}"

          echo "=== Secret Name Validation ==="
          echo "Expected secret names for this run:"
          echo "  - TOKEN_${ENV}"
          echo "  - FIREBASE_APP_ID_ANDROID_${APP}_${ENV}"
          echo "  - API_KEY_${ENV}"
          echo "  - DATABASE_URL_${ENV}"
          echo "  - SUPABASE_URL_${ENV}"
          echo "  - SUPABASE_ANON_KEY_${ENV}"
          echo ""

      - name: Use dynamic secrets with format
        env:
          # Acceso dinámico a secretos usando format()
          TOKEN: ${{ secrets[format('TOKEN_{0}', inputs.ENVIRONMENT || 'QA')] }}

          # Con múltiples variables
          FIREBASE_APP_ID_ANDROID: ${{ secrets[format('FIREBASE_APP_ID_ANDROID_{0}_{1}', inputs.TARGET_APP || 'APP1', inputs.ENVIRONMENT || 'QA')] }}

          # Más ejemplos de secretos dinámicos
          API_KEY: ${{ secrets[format('API_KEY_{0}', inputs.ENVIRONMENT || 'QA')] }}
          DATABASE_URL: ${{ secrets[format('DATABASE_URL_{0}', inputs.ENVIRONMENT || 'QA')] }}
          SUPABASE_URL: ${{ secrets[format('SUPABASE_URL_{0}', inputs.ENVIRONMENT || 'QA')] }}
          SUPABASE_ANON_KEY: ${{ secrets[format('SUPABASE_ANON_KEY_{0}', inputs.ENVIRONMENT || 'QA')] }}

        run: |
          echo "=== Secret Validation Results ==="
          echo "Environment: ${{ inputs.ENVIRONMENT || 'QA' }}"
          echo "Target App: ${{ inputs.TARGET_APP || 'APP1' }}"
          echo ""

          # Validar que los secretos fueron cargados
          echo "Secrets loaded status:"
          echo "- TOKEN configured: $([ -n "$TOKEN" ] && echo '✓ Yes' || echo '✗ No - Secret not found!')"
          echo "- FIREBASE_APP_ID_ANDROID configured: $([ -n "$FIREBASE_APP_ID_ANDROID" ] && echo '✓ Yes' || echo '✗ No - Secret not found!')"
          echo "- API_KEY configured: $([ -n "$API_KEY" ] && echo '✓ Yes' || echo '✗ No - Secret not found!')"
          echo "- DATABASE_URL configured: $([ -n "$DATABASE_URL" ] && echo '✓ Yes' || echo '✗ No - Secret not found!')"
          echo "- SUPABASE_URL configured: $([ -n "$SUPABASE_URL" ] && echo '✓ Yes' || echo '✗ No - Secret not found!')"
          echo "- SUPABASE_ANON_KEY configured: $([ -n "$SUPABASE_ANON_KEY" ] && echo '✓ Yes' || echo '✗ No - Secret not found!')"
          echo ""

          # Validar características del secreto sin exponerlo
          if [ -n "$TOKEN" ]; then
            echo "TOKEN validation:"
            echo "  - Length: ${#TOKEN} characters"
            echo "  - First 4 chars: ${TOKEN:0:4}..."
            echo "  - Last 4 chars: ...${TOKEN: -4}"
            echo "  - MD5 hash: $(echo -n "$TOKEN" | md5sum | cut -d' ' -f1)"
          else
            echo "⚠️  WARNING: TOKEN is empty or not found!"
          fi
          echo ""

          if [ -n "$FIREBASE_APP_ID_ANDROID" ]; then
            echo "FIREBASE_APP_ID_ANDROID validation:"
            echo "  - Length: ${#FIREBASE_APP_ID_ANDROID} characters"
            echo "  - Starts with: ${FIREBASE_APP_ID_ANDROID:0:10}..."
            echo "  - MD5 hash: $(echo -n "$FIREBASE_APP_ID_ANDROID" | md5sum | cut -d' ' -f1)"
          else
            echo "⚠️  WARNING: FIREBASE_APP_ID_ANDROID is empty or not found!"
          fi
          echo ""

          # Validar que diferentes ambientes tienen diferentes secretos
          echo "=== Cross-validation check ==="
          echo "If you run this workflow with different ENVIRONMENT values,"
          echo "the MD5 hashes shown above should be DIFFERENT."
          echo "This confirms you're getting the correct secret for each environment."

      - name: Strict validation (fail if secrets missing)
        env:
          TOKEN: ${{ secrets[format('TOKEN_{0}', inputs.ENVIRONMENT || 'QA')] }}
          FIREBASE_APP_ID_ANDROID: ${{ secrets[format('FIREBASE_APP_ID_ANDROID_{0}_{1}', inputs.TARGET_APP || 'APP1', inputs.ENVIRONMENT || 'QA')] }}
        run: |
          echo "=== Strict Secret Validation ==="

          # Lista de secretos requeridos
          MISSING_SECRETS=()

          if [ -z "$TOKEN" ]; then
            MISSING_SECRETS+=("TOKEN_${{ inputs.ENVIRONMENT || 'QA' }}")
          fi

          if [ -z "$FIREBASE_APP_ID_ANDROID" ]; then
            MISSING_SECRETS+=("FIREBASE_APP_ID_ANDROID_${{ inputs.TARGET_APP || 'APP1' }}_${{ inputs.ENVIRONMENT || 'QA' }}")
          fi

          # Reportar secretos faltantes
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "❌ ERROR: Missing required secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "  - $secret"
            done
            echo ""
            echo "Please configure these secrets in your GitHub repository:"
            echo "Settings -> Secrets and variables -> Actions -> New repository secret"
            exit 1
          fi

          echo "✅ All required secrets are configured correctly!"

      - name: Deploy to environment
        env:
          TOKEN: ${{ secrets[format('TOKEN_{0}', inputs.ENVIRONMENT || 'QA')] }}
          FIREBASE_APP_ID: ${{ secrets[format('FIREBASE_APP_ID_ANDROID_{0}_{1}', inputs.TARGET_APP || 'APP1', inputs.ENVIRONMENT || 'QA')] }}
        run: |
          echo "Starting deployment..."

          # Aquí usarías los secretos para tu deployment real
          # Ejemplo:
          # curl -H "Authorization: Bearer $TOKEN" \
          #      -H "X-Firebase-AppId: $FIREBASE_APP_ID" \
          #      https://api.example.com/deploy

          echo "✅ Deployment completed successfully!"

      - name: Example - Compare secrets across environments
        if: false  # Deshabilitado por defecto - habilita para debug
        env:
          TOKEN_QA: ${{ secrets.TOKEN_QA }}
          TOKEN_PROD: ${{ secrets.TOKEN_PROD }}
        run: |
          echo "=== Environment Comparison (Debug Mode) ==="
          echo "This helps verify you have different secrets per environment"
          echo ""

          if [ -n "$TOKEN_QA" ]; then
            echo "TOKEN_QA hash: $(echo -n "$TOKEN_QA" | md5sum | cut -d' ' -f1)"
          else
            echo "TOKEN_QA: Not configured"
          fi

          if [ -n "$TOKEN_PROD" ]; then
            echo "TOKEN_PROD hash: $(echo -n "$TOKEN_PROD" | md5sum | cut -d' ' -f1)"
          else
            echo "TOKEN_PROD: Not configured"
          fi

          echo ""
          echo "These hashes should be DIFFERENT if secrets are properly configured"
